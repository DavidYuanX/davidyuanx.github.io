<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="A front end siege division built ~"><title>Vue源码分析之 Vue-router 篇 | David's blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/normalize.min.css"><link rel="stylesheet" type="text/css" href="/css/pure-min.css"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="/js/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + 'b5b30c3f05f1d88ff91cf0f233b1fa32';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();

<!-- GrowingIO Analytics code version 2.1 -->
<!-- Copyright 2015-2018 GrowingIO, Inc. More info available at http://www.growingio.com -->
!function(e,t,n,g,i){e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},n=t.createElement("script"),tag=t.getElementsByTagName("script")[0],n.async=1,n.src=('https:'==document.location.protocol?'https://':'http://')+g,tag.parentNode.insertBefore(n,tag)}(window,document,"script","assets.giocdn.com/2.1/gio.js","gio");
  gio('init','9a2bc3f2970e279e', {});

//custom page code begin here

//custom page code end here

gio('send');</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Vue源码分析之 Vue-router 篇</h1><a id="logo" href="/.">David's blog</a><p class="description">Welcome to my den</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Vue源码分析之 Vue-router 篇</h1><div class="post-meta">Jun 10, 2019<span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a class="disqus-comment-count" href="/2019/06/10/Vue-router/#vcomment"> </a><div class="post-content"><h2 id="Vue-router-是什么？"><a href="#Vue-router-是什么？" class="headerlink" title="Vue-router 是什么？"></a>Vue-router 是什么？</h2><p>Vue Router 是 Vue.js 官方的路由管理器。它和 Vue.js 的核心深度集成，让构建单页面应用变得易如反掌。它支持 hash、history、abstract 3 种路由方式，提供了 <router-link> 和 <router-view> 2 种组件，还提供了简单的路由配置和一系列好用的 API。</router-view></router-link></p>
<h2 id="Vue-router-初始化"><a href="#Vue-router-初始化" class="headerlink" title="Vue-router 初始化"></a>Vue-router 初始化</h2><p>Vue.use(VueRouter) 实质上是启动了 VueRouter 的install方法 安装到vue.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initUse</span> (<span class="params">Vue</span>) </span>&#123;</span><br><span class="line">  Vue.use = <span class="function"><span class="keyword">function</span> (<span class="params">plugin</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> installedPlugins = (<span class="keyword">this</span>._installedPlugins || (<span class="keyword">this</span>._installedPlugins = []));</span><br><span class="line">    <span class="keyword">if</span> (installedPlugins.indexOf(plugin) &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// additional parameters</span></span><br><span class="line">    <span class="keyword">var</span> args = toArray(<span class="built_in">arguments</span>, <span class="number">1</span>);</span><br><span class="line">    args.unshift(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> plugin.install === <span class="string">'function'</span>) &#123;</span><br><span class="line">      plugin.install.apply(plugin, args);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> plugin === <span class="string">'function'</span>) &#123;</span><br><span class="line">      plugin.apply(<span class="literal">null</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line">    installedPlugins.push(plugin);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以很清晰的看到，这段代码逻辑，首先会判断 Vue installedPlugins 是否存在，然后执行插件的安装方法，接着将插件存储到 _installedPlugins 中。这个方法的好处是合理利用了this让插件快速找到主体。</p>
<h2 id="Vue-router-安装"><a href="#Vue-router-安装" class="headerlink" title="Vue-router 安装"></a>Vue-router 安装</h2><p>在项目中 import VueRouter from ‘vue-router’ 的时候，实际上引用的是一个对象，它的定义在/node_modules/vue-router，在文件夹下很容易就能找到安装方法，这里我采用debugger的模式去循循渐进刨析源码：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">function install (Vue) &#123;</span><br><span class="line">  <span class="keyword">if</span> (install.installed &amp;&amp; _Vue === Vue) &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">  install.installed = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  _Vue = Vue;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> isDef = function (v) &#123; <span class="keyword">return</span> v !== undefined; &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> registerInstance = function (vm, callVal) &#123;</span><br><span class="line">    <span class="keyword">var</span> i = vm.$options._parentVnode;</span><br><span class="line">    <span class="keyword">if</span> (isDef(i) &amp;&amp; isDef(i = i.<span class="keyword">data</span>) &amp;&amp; isDef(i = i.registerRouteInstance)) &#123;</span><br><span class="line">      i(vm, callVal);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Vue.mixin(&#123;</span><br><span class="line">    beforeCreate: function beforeCreate () &#123;</span><br><span class="line">      <span class="keyword">if</span> (isDef(<span class="keyword">this</span>.$options.router)) &#123;</span><br><span class="line">        <span class="keyword">this</span>._routerRoot = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">this</span>._router = <span class="keyword">this</span>.$options.router;</span><br><span class="line">        <span class="keyword">this</span>._router.<span class="keyword">init</span>(<span class="keyword">this</span>);</span><br><span class="line">        Vue.util.defineReactive(<span class="keyword">this</span>, <span class="string">'_route'</span>, <span class="keyword">this</span>._router.history.current);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>._routerRoot = (<span class="keyword">this</span>.$parent &amp;&amp; <span class="keyword">this</span>.$parent._routerRoot) || <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      registerInstance(<span class="keyword">this</span>, <span class="keyword">this</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    destroyed: function destroyed () &#123;</span><br><span class="line">      registerInstance(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  Object.defineProperty(Vue.prototype, <span class="string">'$router'</span>, &#123;</span><br><span class="line">    <span class="keyword">get</span>: function <span class="keyword">get</span> () &#123; <span class="keyword">return</span> <span class="keyword">this</span>._routerRoot._router &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  Object.defineProperty(Vue.prototype, <span class="string">'$route'</span>, &#123;</span><br><span class="line">    <span class="keyword">get</span>: function <span class="keyword">get</span> () &#123; <span class="keyword">return</span> <span class="keyword">this</span>._routerRoot._route &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  Vue.component(<span class="string">'RouterView'</span>, View);</span><br><span class="line">  Vue.component(<span class="string">'RouterLink'</span>, Link);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> strats = Vue.config.optionMergeStrategies;</span><br><span class="line">  <span class="comment">// use the same hook merging strategy for route hooks</span></span><br><span class="line">  strats.beforeRouteEnter = strats.beforeRouteLeave = strats.beforeRouteUpdate = strats.created;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里为确保路由只注册一次，用了installed变量作为记号。这里最重要的一点就是使用Vue.mixin混淆 beforeCreate 和 destroyed 钩子函数注入到每一个组件中。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initMixin$1</span> (<span class="params">Vue</span>) </span>&#123;</span><br><span class="line">  Vue.mixin = <span class="function"><span class="keyword">function</span> (<span class="params">mixin</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.options = mergeOptions(<span class="keyword">this</span>.options, mixin);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过 debugger 我们可以发现，这一步 主要是通过mergeOptions函数将 mixin 中的beforeCreate 和 destroyed 钩子函数合并到vue.options。debugger跳回Vue-Router 的 install 方法，可以看到混入的<br>beforeCreate 钩子函数 主要是定义了this._routerRoot 表示当前vue实例，this._router 表示 VueRouter 的实例 router，它是在new Vue 时传入的。还执行了 this._router.init() 方法初始化 router。defineReactive 方法 是把this._route 变成响应式对象，刚刚有提到this._routerRoot 表示当前vue实例，所以在执行该钩子函数时this._routerRoot 始终指向的最后一个传入了 router 对象的父实例。</p>
<p>接着给 Vue 原型上定义了 $router 和 $route 2 个属性的 get 方法，这就是为什么我们可以在组件实例上可以访问 this.$router 以及 this.$route。</p>
<p>接着又通过 Vue.component 方法定义了全局的 <router-link> 和 <router-view> 2 个组件，这也是为什么我们在写模板的时候可以使用这两个标签。最后是定义了路由中的钩子函数的合并策略。</router-view></router-link></p>
<h2 id="路径切换"><a href="#路径切换" class="headerlink" title="路径切换"></a>路径切换</h2><p>接下来我们看看 vue-router是如何使用的。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">VueRouter.prototype.push = <span class="function"><span class="keyword">function</span> <span class="title">push</span> (<span class="params">location, onComplete, onAbort</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="keyword">this</span>$<span class="number">1</span> = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// $flow-disable-line</span></span><br><span class="line">  <span class="keyword">if</span> (!onComplete &amp;&amp; !onAbort &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">Promise</span> !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>$<span class="number">1.</span>history.push(location, resolve, reject);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.history.push(location, onComplete, onAbort);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">HTML5History.prototype.push = <span class="function"><span class="keyword">function</span> <span class="title">push</span> (<span class="params">location, onComplete, onAbort</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> <span class="keyword">this</span>$<span class="number">1</span> = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> ref = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">var</span> fromRoute = ref.current;</span><br><span class="line">  <span class="keyword">this</span>.transitionTo(location, <span class="function"><span class="keyword">function</span> (<span class="params">route</span>) </span>&#123;</span><br><span class="line">    pushState(cleanPath(<span class="keyword">this</span>$<span class="number">1.</span>base + route.fullPath));</span><br><span class="line">    handleScroll(<span class="keyword">this</span>$<span class="number">1.</span>router, route, fromRoute, <span class="literal">false</span>);</span><br><span class="line">    onComplete &amp;&amp; onComplete(route);</span><br><span class="line">  &#125;, onAbort);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>通过 debugger 我们可以发现，实则 他是调用了 transitionTo 方法：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">History.prototype.transitionTo = <span class="function"><span class="keyword">function</span> <span class="title">transitionTo</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  location,</span></span></span><br><span class="line"><span class="function"><span class="params">  onComplete,</span></span></span><br><span class="line"><span class="function"><span class="params">  onAbort</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="keyword">this</span>$<span class="number">1</span> = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> route = <span class="keyword">this</span>.router.match(location, <span class="keyword">this</span>.current);</span><br><span class="line">  <span class="keyword">this</span>.confirmTransition(</span><br><span class="line">    route,</span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>$<span class="number">1.</span>updateRoute(route);</span><br><span class="line">      onComplete &amp;&amp; onComplete(route);</span><br><span class="line">      <span class="keyword">this</span>$<span class="number">1.</span>ensureURL();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// fire ready cbs once</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>$<span class="number">1.</span>ready) &#123;</span><br><span class="line">        <span class="keyword">this</span>$<span class="number">1.</span>ready = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">this</span>$<span class="number">1.</span>readyCbs.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">cb</span>) </span>&#123;</span><br><span class="line">          cb(route);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (onAbort) &#123;</span><br><span class="line">        onAbort(err);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (err &amp;&amp; !<span class="keyword">this</span>$<span class="number">1.</span>ready) &#123;</span><br><span class="line">        <span class="keyword">this</span>$<span class="number">1.</span>ready = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">this</span>$<span class="number">1.</span>readyErrorCbs.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">cb</span>) </span>&#123;</span><br><span class="line">          cb(err);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>先看第一行代码，它调用了 this.router.match 函数：<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">VueRouter.prototype.<span class="built_in">match</span> = <span class="function"><span class="keyword">function</span> <span class="title">match</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  raw,</span></span></span><br><span class="line"><span class="function"><span class="params">  current,</span></span></span><br><span class="line"><span class="function"><span class="params">  redirectedFrom</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> this.matcher.<span class="built_in">match</span>(raw, current, redirectedFrom)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>实际上是调用了 this.matcher.match 方法去做匹配，matcher 匹配规则稍后在看。先把 transitionTo 方法看完。<br>拿到新的路径后，那么接下来就会执行 confirmTransition 方法去做真正的切换，由于这个过程可能有一些异步的操作（如异步组件），所以整个 confirmTransition API 设计成带有成功回调函数和失败回调函数，先来看一下它的定义：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">History.prototype.confirmTransition = <span class="function"><span class="keyword">function</span> <span class="title">confirmTransition</span> (<span class="params">route, onComplete, onAbort</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="keyword">this</span>$<span class="number">1</span> = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> current = <span class="keyword">this</span>.current;</span><br><span class="line">    <span class="keyword">var</span> abort = <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// after merging https://github.com/vuejs/vue-router/pull/2771 we</span></span><br><span class="line">      <span class="comment">// When the user navigates through history through back/forward buttons</span></span><br><span class="line">      <span class="comment">// we do not want to throw the error. We only throw it if directly calling</span></span><br><span class="line">      <span class="comment">// push/replace. That's why it's not included in isError</span></span><br><span class="line">      <span class="keyword">if</span> (!isExtendedError(NavigationDuplicated, err) &amp;&amp; isError(err)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>$<span class="number">1.</span>errorCbs.length) &#123;</span><br><span class="line">          <span class="keyword">this</span>$<span class="number">1.</span>errorCbs.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">cb</span>) </span>&#123;</span><br><span class="line">            cb(err);</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          warn(<span class="literal">false</span>, <span class="string">'uncaught error during route navigation:'</span>);</span><br><span class="line">          <span class="built_in">console</span>.error(err);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      onAbort &amp;&amp; onAbort(err);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      isSameRoute(route, current) &amp;&amp;</span><br><span class="line">      <span class="comment">// in the case the route map has been dynamically appended to</span></span><br><span class="line">      route.matched.length === current.matched.length</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">this</span>.ensureURL();</span><br><span class="line">      <span class="keyword">return</span> abort(<span class="keyword">new</span> NavigationDuplicated(route))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> ref = resolveQueue(</span><br><span class="line">      <span class="keyword">this</span>.current.matched,</span><br><span class="line">      route.matched</span><br><span class="line">    );</span><br><span class="line">      <span class="keyword">var</span> updated = ref.updated;</span><br><span class="line">      <span class="keyword">var</span> deactivated = ref.deactivated;</span><br><span class="line">      <span class="keyword">var</span> activated = ref.activated;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> queue = [].concat(</span><br><span class="line">      <span class="comment">// in-component leave guards</span></span><br><span class="line">      extractLeaveGuards(deactivated),</span><br><span class="line">      <span class="comment">// global before hooks</span></span><br><span class="line">      <span class="keyword">this</span>.router.beforeHooks,</span><br><span class="line">      <span class="comment">// in-component update hooks</span></span><br><span class="line">      extractUpdateHooks(updated),</span><br><span class="line">      <span class="comment">// in-config enter guards</span></span><br><span class="line">      activated.map(<span class="function"><span class="keyword">function</span> (<span class="params">m</span>) </span>&#123; <span class="keyword">return</span> m.beforeEnter; &#125;),</span><br><span class="line">      <span class="comment">// async components</span></span><br><span class="line">      resolveAsyncComponents(activated)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.pending = route;</span><br><span class="line">    <span class="keyword">var</span> iterator = <span class="function"><span class="keyword">function</span> (<span class="params">hook, next</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>$<span class="number">1.</span>pending !== route) &#123;</span><br><span class="line">        <span class="keyword">return</span> abort()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        hook(route, current, <span class="function"><span class="keyword">function</span> (<span class="params">to</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (to === <span class="literal">false</span> || isError(to)) &#123;</span><br><span class="line">            <span class="comment">// next(false) -&gt; abort navigation, ensure current URL</span></span><br><span class="line">            <span class="keyword">this</span>$<span class="number">1.</span>ensureURL(<span class="literal">true</span>);</span><br><span class="line">            abort(to);</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">            <span class="keyword">typeof</span> to === <span class="string">'string'</span> ||</span><br><span class="line">            (<span class="keyword">typeof</span> to === <span class="string">'object'</span> &amp;&amp;</span><br><span class="line">              (<span class="keyword">typeof</span> to.path === <span class="string">'string'</span> || <span class="keyword">typeof</span> to.name === <span class="string">'string'</span>))</span><br><span class="line">          ) &#123;</span><br><span class="line">            <span class="comment">// next('/') or next(&#123; path: '/' &#125;) -&gt; redirect</span></span><br><span class="line">            abort();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> to === <span class="string">'object'</span> &amp;&amp; to.replace) &#123;</span><br><span class="line">              <span class="keyword">this</span>$<span class="number">1.</span>replace(to);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="keyword">this</span>$<span class="number">1.</span>push(to);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// confirm transition and pass on the value</span></span><br><span class="line">            next(to);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        abort(e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    runQueue(queue, iterator, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> postEnterCbs = [];</span><br><span class="line">      <span class="keyword">var</span> isValid = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>$<span class="number">1.</span>current === route; &#125;;</span><br><span class="line">      <span class="comment">// wait until async components are resolved before</span></span><br><span class="line">      <span class="comment">// extracting in-component enter guards</span></span><br><span class="line">      <span class="keyword">var</span> enterGuards = extractEnterGuards(activated, postEnterCbs, isValid);</span><br><span class="line">      <span class="keyword">var</span> queue = enterGuards.concat(<span class="keyword">this</span>$<span class="number">1.</span>router.resolveHooks);</span><br><span class="line">      runQueue(queue, iterator, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>$<span class="number">1.</span>pending !== route) &#123;</span><br><span class="line">          <span class="keyword">return</span> abort()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>$<span class="number">1.</span>pending = <span class="literal">null</span>;</span><br><span class="line">        onComplete(route);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>$<span class="number">1.</span>router.app) &#123;</span><br><span class="line">          <span class="keyword">this</span>$<span class="number">1.</span>router.app.$nextTick(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            postEnterCbs.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">cb</span>) </span>&#123;</span><br><span class="line">              cb();</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure></p>
<p>这里定义了 abort 函数，然后判断 route 和 current 是相同路径的话，则直接调用 this.ensureUrl 和 abort 函数抛出错误 和 调用 函数终止回调。<br>谈后又根据 current.matched 和 route.matched 执行了 resolveQueue 方法解析出 3 个数组队列，分别保存即将前往以及当前的页面的参数：<br><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolveQueue</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  current,</span></span></span><br><span class="line"><span class="function"><span class="params">  next</span></span></span><br><span class="line"><span class="function"><span class="params">)</span> &#123;</span></span><br><span class="line">  var <span class="built_in">i</span>;</span><br><span class="line">  var <span class="built_in">max</span> = Math.<span class="built_in">max</span>(current.<span class="built_in">length</span>, next.<span class="built_in">length</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="built_in">i</span> = <span class="number">0</span>; <span class="built_in">i</span> &lt; <span class="built_in">max</span>; <span class="built_in">i</span>++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (current[<span class="built_in">i</span>] !== next[<span class="built_in">i</span>]) &#123;</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    updated: next.slice(<span class="number">0</span>, <span class="built_in">i</span>),</span><br><span class="line">    activated: next.slice(<span class="built_in">i</span>),</span><br><span class="line">    deactivated: current.slice(<span class="built_in">i</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来就来到了导航守卫，守卫是我在狼人杀里面喜欢的一个角色（哈哈）。这里的主要逻辑是在 runQueue 函数:<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span></span> runQueue (queue, fn, cb) &#123;</span><br><span class="line">  var step = <span class="function"><span class="keyword">function</span></span> (<span class="built_in">index</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">index</span> &gt;= queue.length) &#123;</span><br><span class="line">      cb();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (queue[<span class="built_in">index</span>]) &#123;</span><br><span class="line">        fn(queue[<span class="built_in">index</span>], <span class="function"><span class="keyword">function</span></span> () &#123;</span><br><span class="line">          step(<span class="built_in">index</span> + <span class="number">1</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        step(<span class="built_in">index</span> + <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  step(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到 是一个典型的异步函数队列执行函数，queue 是一个导航卫士类型的数组，每次根据queue的循环递增取到一个守卫，通过fn 去执行 ，这里的fn 就是刚才的 iterator 函数，定义如下：<br><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">var iterator = <span class="keyword">function</span> (hook, <span class="keyword">next</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (this<span class="variable">$1</span>.pending !== route) &#123;</span><br><span class="line">    <span class="keyword">return</span> abort()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    hook(route, current, <span class="keyword">function</span> (<span class="keyword">to</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">to</span> ===<span class="built_in"> false</span> || isError(<span class="keyword">to</span>)) &#123;</span><br><span class="line">        // <span class="keyword">next</span><span class="built_in">(false</span>) -&gt; abort navigation, ensure current URL</span><br><span class="line">        this<span class="variable">$1</span>.ensureURL<span class="built_in">(true</span>);</span><br><span class="line">        abort(<span class="keyword">to</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">        typeof <span class="keyword">to</span> === <span class="string">'string'</span> ||</span><br><span class="line">        (typeof <span class="keyword">to</span> === <span class="string">'object'</span> &amp;&amp;</span><br><span class="line">          (typeof <span class="keyword">to</span><span class="built_in">.path</span> === <span class="string">'string'</span> || typeof <span class="keyword">to</span><span class="built_in">.name</span> === <span class="string">'string'</span>))</span><br><span class="line">      ) &#123;</span><br><span class="line">        // <span class="keyword">next</span>(<span class="string">'/'</span>) <span class="keyword">or</span> <span class="keyword">next</span>(&#123;<span class="built_in"> path</span>: <span class="string">'/'</span> &#125;) -&gt; redirect</span><br><span class="line">        abort();</span><br><span class="line">        <span class="keyword">if</span> (typeof <span class="keyword">to</span> === <span class="string">'object'</span> &amp;&amp; <span class="keyword">to</span><span class="built_in">.replace</span>) &#123;</span><br><span class="line">          this<span class="variable">$1</span><span class="built_in">.replace</span>(<span class="keyword">to</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          this<span class="variable">$1</span>.push(<span class="keyword">to</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        // confirm transition <span class="keyword">and</span> pass on the <span class="keyword">value</span></span><br><span class="line">        <span class="keyword">next</span>(<span class="keyword">to</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    abort(e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>这里会首先做一个验证，当前待跳转的是否为当前route，然后执行每一个守卫的hook，并传入 route、current 和匿名函数，对应守卫入参时的to, from, next，这里大致就是当执行了匿名函数，会根据一些条件执行 abort 或 next，只有执行 next 的时候，才会前进到下一个导航守卫钩子函数中，这也就是为什么官方文档会说只有执行 next 方法来 resolve 这个钩子函数。</p>
<p>以下还是要多研究<br>那么最后我们来看 queue 是怎么构造的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> queue = [].concat(</span><br><span class="line">  <span class="comment">// in-component leave guards</span></span><br><span class="line">  extractLeaveGuards(deactivated),</span><br><span class="line">  <span class="comment">// global before hooks</span></span><br><span class="line">  <span class="keyword">this</span>.router.beforeHooks,</span><br><span class="line">  <span class="comment">// in-component update hooks</span></span><br><span class="line">  extractUpdateHooks(updated),</span><br><span class="line">  <span class="comment">// in-config enter guards</span></span><br><span class="line">  activated.map(<span class="function"><span class="keyword">function</span> (<span class="params">m</span>) </span>&#123; <span class="keyword">return</span> m.beforeEnter; &#125;),</span><br><span class="line">  <span class="comment">// async components</span></span><br><span class="line">  resolveAsyncComponents(activated)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>按照顺序如下：<br>  1、在失活的组件里调用离开守卫。<br>  2、调用全局的 beforeEach 守卫。<br>  3、在重用的组件里调用 beforeRouteUpdate 守卫<br>  4、在激活的路由配置里调用 beforeEnter。<br>  5、解析异步路由组件。<br>  6、在被激活的组件里调用 beforeRouteEnter。<br>  7、调用全局的 beforeResolve 守卫。<br>  8、调用全局的 afterEach 钩子。</p>
<p>  其中6、7步会在runQueue方法的回调中执行：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">runQueue(queue, iterator, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> postEnterCbs = [];</span><br><span class="line">  <span class="keyword">var</span> isValid = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>$<span class="number">1.</span>current === route; &#125;;</span><br><span class="line">  <span class="comment">// wait until async components are resolved before</span></span><br><span class="line">  <span class="comment">// extracting in-component enter guards</span></span><br><span class="line">  <span class="keyword">var</span> enterGuards = extractEnterGuards(activated, postEnterCbs, isValid);</span><br><span class="line">  <span class="keyword">var</span> queue = enterGuards.concat(<span class="keyword">this</span>$<span class="number">1.</span>router.resolveHooks);</span><br><span class="line">  runQueue(queue, iterator, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>$<span class="number">1.</span>pending !== route) &#123;</span><br><span class="line">      <span class="keyword">return</span> abort()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>$<span class="number">1.</span>pending = <span class="literal">null</span>;</span><br><span class="line">    onComplete(route);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>$<span class="number">1.</span>router.app) &#123;</span><br><span class="line">      <span class="keyword">this</span>$<span class="number">1.</span>router.app.$nextTick(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        postEnterCbs.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">cb</span>) </span>&#123;</span><br><span class="line">          cb();</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>第八步是在最后执行了 onComplete(route) 后，会执行 this.updateRoute(route) 方法：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">updateRoute (route: Route) &#123;</span><br><span class="line">  <span class="keyword">const</span> prev = <span class="keyword">this</span>.current</span><br><span class="line">  <span class="keyword">this</span>.current = route</span><br><span class="line">  <span class="keyword">this</span>.cb &amp;&amp; <span class="keyword">this</span>.cb(route)</span><br><span class="line">  <span class="keyword">this</span>.router.afterHooks.forEach(hook =&gt; &#123;</span><br><span class="line">    hook &amp;&amp; hook(route, prev)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当用户使用 router.afterEach 注册了一个全局守卫，就会往 router.afterHooks 添加一个钩子函数，这样 this.router.afterHooks 获取的就是用户注册的全局 afterHooks 守卫。</p>
<p>那么至此我们把所有导航守卫的执行分析完毕了，我们知道路由切换除了执行这些钩子函数，从表象上有 2 个地方会发生变化，一个是 url 发生变化，一个是组件发生变化。接下来我们分别介绍这两块的实现原理。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>编写 Vue 插件通常需要提供静态的 install 方法，谈后通过 Vue.use(plugin) 时候，就会执行插件的 install 方法。如上Vue-Router 的 install 方法是给每一个组件注入 beforeCreate 和 destoryed 钩子函数，在 beforeCreate 做一些关于Vue-Router 的操作。</p>
</div><iframe src="/donate/?AliPayQR=/img/alipay.jpeg&amp;WeChatQR=null&amp;GitHub=https://github.com/DavidYuanX&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><div class="tags"><a href="/tags/Vue/">Vue</a><a href="/tags/vue-router/">vue-router</a></div><div class="post-nav"><a class="pre" href="/2019/07/05/CentOS/">CentOS 搭建 服务端</a><a class="next" href="/2019/06/02/Vuex-原理分析/">Vue源码分析之Vuex 篇</a></div><div id="vcomment"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/@waline/client@v2/dist/waline.css"><script src="//unpkg.com/@waline/client@v2/dist/waline.js"></script><script>const waline = Waline.init({
  el: '#vcomment',
  path: decodeURI(location.pathname) || '/',
  lang: 'zh-cn',
  serverURL: 'https://vercel-xi-gilt.vercel.app',
  pageSize:'10'
});</script></div></div></div><aside class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input class="popup-trigger" placeholder="Search" readonly="readonly"></div></div><div class="toc-article" id="toc"><div class="toc-title">Categories<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Vue-router-是什么？"><span class="toc-number">1.</span> <span class="toc-text">Vue-router 是什么？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vue-router-初始化"><span class="toc-number">2.</span> <span class="toc-text">Vue-router 初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vue-router-安装"><span class="toc-number">3.</span> <span class="toc-text">Vue-router 安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#路径切换"><span class="toc-number">4.</span> <span class="toc-text">路径切换</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li></ol></div></div></div></aside><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2022 <a href="/." rel="nofollow">David's blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv"><i class="fa fa-eye" aria-hidden="true"></i> <span id="busuanzi_value_site_pv"></span> times</span></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/underscore-min.js"></script><script type="text/javascript" src="/js/inView.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>