<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="A front end siege division built ~"><title>Vue源码分析之Vuex 篇 | David's blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/normalize.min.css"><link rel="stylesheet" type="text/css" href="/css/pure-min.css"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="/js/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + 'b5b30c3f05f1d88ff91cf0f233b1fa32';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();

<!-- GrowingIO Analytics code version 2.1 -->
<!-- Copyright 2015-2018 GrowingIO, Inc. More info available at http://www.growingio.com -->
!function(e,t,n,g,i){e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},n=t.createElement("script"),tag=t.getElementsByTagName("script")[0],n.async=1,n.src=('https:'==document.location.protocol?'https://':'http://')+g,tag.parentNode.insertBefore(n,tag)}(window,document,"script","assets.giocdn.com/2.1/gio.js","gio");
  gio('init','9a2bc3f2970e279e', {});

//custom page code begin here

//custom page code end here

gio('send');</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Vue源码分析之Vuex 篇</h1><a id="logo" href="/.">David's blog</a><p class="description">Welcome to my den</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Vue源码分析之Vuex 篇</h1><div class="post-meta">Jun 2, 2019<span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a class="disqus-comment-count" href="/2019/06/02/Vuex-原理分析/#vcomment"> </a><div class="post-content"><h2 id="Vuex-是什么？"><a href="#Vuex-是什么？" class="headerlink" title="Vuex 是什么？"></a>Vuex 是什么？</h2><p>Vuex 是一个专为 Vue.js 应用程序开发的状态管理模式。它采用集中式存储管理应用的所有组件的状态，并以利用 Vue.js 的细粒度数据响应机制来进行高效的状态更新。它的核心概念有State，Getter，Mutation，Action，Module。</p>
<img src="https://vuex.vuejs.org/vuex.png" title="title Vuex" alt="alt Vuex">
<h2 id="Vuex-初始化"><a href="#Vuex-初始化" class="headerlink" title="Vuex 初始化"></a>Vuex 初始化</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>在项目中 import Vuex from ‘vuex’ 的时候，实际上引用的是一个对象，它的定义在/node_modules/vuex 中：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">var</span> <span class="string">index</span> <span class="string">=</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="attr">Store:</span> <span class="string">Store,</span></span><br><span class="line">    <span class="attr">install:</span> <span class="string">install,</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">'3.1.2'</span><span class="string">,</span></span><br><span class="line">    <span class="attr">mapState:</span> <span class="string">mapState,</span></span><br><span class="line">    <span class="attr">mapMutations:</span> <span class="string">mapMutations,</span></span><br><span class="line">    <span class="attr">mapGetters:</span> <span class="string">mapGetters,</span></span><br><span class="line">    <span class="attr">mapActions:</span> <span class="string">mapActions,</span></span><br><span class="line">    <span class="attr">createNamespacedHelpers:</span> <span class="string">createNamespacedHelpers</span></span><br><span class="line">  <span class="string">&#125;;</span></span><br><span class="line"><span class="string">return</span> <span class="string">index;</span></span><br></pre></td></tr></table></figure></p>
<p>Vue.use(Vuex) 实质上是启动了 vuex 的install方法 安装到vue<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initUse</span> (<span class="params">Vue</span>) </span>&#123;</span><br><span class="line">  Vue.use = <span class="function"><span class="keyword">function</span> (<span class="params">plugin</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> installedPlugins = (<span class="keyword">this</span>._installedPlugins || (<span class="keyword">this</span>._installedPlugins = []));</span><br><span class="line">    <span class="keyword">if</span> (installedPlugins.indexOf(plugin) &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// additional parameters</span></span><br><span class="line">    <span class="keyword">var</span> args = toArray(<span class="built_in">arguments</span>, <span class="number">1</span>);</span><br><span class="line">    args.unshift(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> plugin.install === <span class="string">'function'</span>) &#123;</span><br><span class="line">      plugin.install.apply(plugin, args);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> plugin === <span class="string">'function'</span>) &#123;</span><br><span class="line">      plugin.apply(<span class="literal">null</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line">    installedPlugins.push(plugin);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">install</span> (<span class="params">_Vue</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (Vue &amp;&amp; _Vue === Vue) &#123;</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      <span class="built_in">console</span>.error(</span><br><span class="line">        <span class="string">'[vuex] already installed. Vue.use(Vuex) should be called only once.'</span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  Vue = _Vue;</span><br><span class="line">  applyMixin(Vue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看出install 的逻辑很简单，就是把传入的 _Vue 赋值给 Vue 并执行了 applyMixin(Vue) 方法。<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">function applyMixin (Vue) &#123;</span><br><span class="line">    var version = Number(Vue.version.split(<span class="string">'.'</span>)[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (version &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">      Vue.mixin(&#123; beforeCreate: vuexInit &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// override init and inject vuex init procedure</span></span><br><span class="line">      <span class="comment">// for 1.x backwards compatibility.</span></span><br><span class="line">      var _init = Vue.prototype._init;</span><br><span class="line">      Vue.prototype._init = function (<span class="keyword">options</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( <span class="keyword">options</span> === <span class="keyword">void</span> <span class="number">0</span> ) <span class="keyword">options</span> = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">options</span>.init = <span class="keyword">options</span>.init</span><br><span class="line">          ? [vuexInit].concat(<span class="keyword">options</span>.init)</span><br><span class="line">          : vuexInit;</span><br><span class="line">        _init.<span class="keyword">call</span>(<span class="keyword">this</span>, <span class="keyword">options</span>);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Vuex init hook, injected into each instances init hooks list.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    function vuexInit () &#123;</span><br><span class="line">      var <span class="keyword">options</span> = <span class="keyword">this</span>.$<span class="keyword">options</span>;</span><br><span class="line">      <span class="comment">// store injection</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">options</span>.store) &#123;</span><br><span class="line">        <span class="keyword">this</span>.$store = typeof <span class="keyword">options</span>.store === <span class="string">'function'</span></span><br><span class="line">          ? <span class="keyword">options</span>.store()</span><br><span class="line">          : <span class="keyword">options</span>.store;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">options</span>.parent &amp;&amp; <span class="keyword">options</span>.parent.$store) &#123;</span><br><span class="line">        <span class="keyword">this</span>.$store = <span class="keyword">options</span>.parent.$store;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>从applyMixin方法中可以看出它会先判断Vue版本号，对于 Vue 2.0 以上版本，它其实就全局混入了一个 beforeCreate 钩子函数，在创建前把 options.store 保存在所有组件的 this.$store 中，这个 options.store 就是我们在实例化 Store 对象的实例。</p>
<h3 id="Store-实例化"><a href="#Store-实例化" class="headerlink" title="Store 实例化"></a>Store 实例化</h3><p>其实 这里 大致 可以分为三步：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Store = <span class="function"><span class="keyword">function</span> <span class="title">Store</span> (<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> <span class="keyword">this</span>$<span class="number">1</span> = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">if</span> ( options === <span class="keyword">void</span> <span class="number">0</span> ) options = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Auto install if it is not done yet and `window` has `Vue`.</span></span><br><span class="line">  <span class="comment">// To allow users to avoid auto-installation in some cases,</span></span><br><span class="line">  <span class="comment">// this code should be placed here. See #731</span></span><br><span class="line">  <span class="keyword">if</span> (!Vue &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">window</span> !== <span class="string">'undefined'</span> &amp;&amp; <span class="built_in">window</span>.Vue) &#123;</span><br><span class="line">    install(<span class="built_in">window</span>.Vue);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    assert(Vue, <span class="string">"must call Vue.use(Vuex) before creating a store instance."</span>);</span><br><span class="line">    assert(<span class="keyword">typeof</span> <span class="built_in">Promise</span> !== <span class="string">'undefined'</span>, <span class="string">"vuex requires a Promise polyfill in this browser."</span>);</span><br><span class="line">    assert(<span class="keyword">this</span> <span class="keyword">instanceof</span> Store, <span class="string">"store must be called with the new operator."</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> plugins = options.plugins; <span class="keyword">if</span> ( plugins === <span class="keyword">void</span> <span class="number">0</span> ) plugins = [];</span><br><span class="line">  <span class="keyword">var</span> strict = options.strict; <span class="keyword">if</span> ( strict === <span class="keyword">void</span> <span class="number">0</span> ) strict = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// store internal state</span></span><br><span class="line">  <span class="keyword">this</span>._committing = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">this</span>._actions = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">this</span>._actionSubscribers = [];</span><br><span class="line">  <span class="keyword">this</span>._mutations = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">this</span>._wrappedGetters = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">this</span>._modules = <span class="keyword">new</span> ModuleCollection(options); 第一步：实例化模块，创建模块树</span><br><span class="line">  <span class="keyword">this</span>._modulesNamespaceMap = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">this</span>._subscribers = [];</span><br><span class="line">  <span class="keyword">this</span>._watcherVM = <span class="keyword">new</span> Vue();</span><br><span class="line">  <span class="keyword">this</span>._makeLocalGettersCache = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// bind commit and dispatch to self</span></span><br><span class="line">  <span class="keyword">var</span> store = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">var</span> ref = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">var</span> dispatch = ref.dispatch;</span><br><span class="line">  <span class="keyword">var</span> commit = ref.commit;</span><br><span class="line">  <span class="keyword">this</span>.dispatch = <span class="function"><span class="keyword">function</span> <span class="title">boundDispatch</span> (<span class="params">type, payload</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> dispatch.call(store, type, payload)</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">this</span>.commit = <span class="function"><span class="keyword">function</span> <span class="title">boundCommit</span> (<span class="params">type, payload, options</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> commit.call(store, type, payload, options)</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// strict mode</span></span><br><span class="line">  <span class="keyword">this</span>.strict = strict;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> state = <span class="keyword">this</span>._modules.root.state; </span><br><span class="line"></span><br><span class="line">  <span class="comment">// init root module.</span></span><br><span class="line">  <span class="comment">// this also recursively registers all sub-modules</span></span><br><span class="line">  <span class="comment">// and collects all module getters inside this._wrappedGetters</span></span><br><span class="line">  installModule(<span class="keyword">this</span>, state, [], <span class="keyword">this</span>._modules.root); 第二步：安装模块</span><br><span class="line"></span><br><span class="line">  <span class="comment">// initialize the store vm, which is responsible for the reactivity</span></span><br><span class="line">  <span class="comment">// (also registers _wrappedGetters as computed properties)</span></span><br><span class="line">  resetStoreVM(<span class="keyword">this</span>, state); 第三部 注册 Store 实例</span><br><span class="line"></span><br><span class="line">  <span class="comment">// apply plugins</span></span><br><span class="line">  plugins.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">plugin</span>) </span>&#123; <span class="keyword">return</span> plugin(<span class="keyword">this</span>$<span class="number">1</span>); &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> useDevtools = options.devtools !== <span class="literal">undefined</span> ? options.devtools : Vue.config.devtools;</span><br><span class="line">  <span class="keyword">if</span> (useDevtools) &#123;</span><br><span class="line">    devtoolPlugin(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="第一步：实例化模块，创建模块树"><a href="#第一步：实例化模块，创建模块树" class="headerlink" title="第一步：实例化模块，创建模块树"></a>第一步：实例化模块，创建模块树</h4><p>模块对于 Vuex 的意义：如果应用变得复杂时，使用单一状态树，应用的所有状态会集中到一个比较大的对象，store 对象就有可能变得相当臃肿。Vuex 为了解决这个问题允许我们将 store 分割成模块（module）。并且每个模块拥有自己的 state、mutation、action、getter。<br>但从数据结构来看，模块的设计是树形结构，自己是一个 root module 模块，下面有子模块Vuex 需要完成这颗树的构建，构建过程的入口就是：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>._modules = <span class="keyword">new</span> ModuleCollection(<span class="keyword">options</span>)</span><br></pre></td></tr></table></figure></p>
<p>通过 debugger 可以发现 ModuleCollection 的实例化过程实则是执行了 register 方法。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ModuleCollection = <span class="function"><span class="keyword">function</span> <span class="title">ModuleCollection</span> (<span class="params">rawRootModule</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// register root module (Vuex.Store options)</span></span><br><span class="line">  <span class="keyword">this</span>.register([], rawRootModule, <span class="literal">false</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">ModuleCollection.prototype.register = <span class="function"><span class="keyword">function</span> <span class="title">register</span> </span>(path, rawModule, runtime) &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">this</span>$<span class="number">1</span> = <span class="built_in">this</span>;</span><br><span class="line">    <span class="keyword">if</span> ( runtime === void <span class="number">0</span> ) runtime = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    assertRawModule(path, rawModule);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> <span class="keyword">new</span><span class="type">Module</span> = <span class="keyword">new</span> <span class="type">Module</span>(rawModule, runtime);</span><br><span class="line">  <span class="keyword">if</span> (path.length === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.root = <span class="keyword">new</span><span class="type">Module</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> parent = <span class="built_in">this</span>.<span class="keyword">get</span>(path.slice(<span class="number">0</span>, <span class="number">-1</span>));</span><br><span class="line">    parent.addChild(path[path.length - <span class="number">1</span>], <span class="keyword">new</span><span class="type">Module</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// register nested modules</span></span><br><span class="line">  <span class="keyword">if</span> (rawModule.modules) &#123;</span><br><span class="line">    forEachValue(rawModule.modules, <span class="function"><span class="keyword">function</span> </span>(rawChildModule, key) &#123;</span><br><span class="line">      <span class="built_in">this</span>$<span class="number">1.</span>register(path.concat(key), rawChildModule, runtime);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>register 方法 首先是 通过 var newModule = new Module(rawModule, runtime) 得到modules实例;<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Module = <span class="function"><span class="keyword">function</span> <span class="title">Module</span> (<span class="params">rawModule, runtime</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.runtime = runtime;</span><br><span class="line">  <span class="comment">// Store some children item</span></span><br><span class="line">  <span class="keyword">this</span>._children = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</span><br><span class="line">  <span class="comment">// Store the origin module object which passed by programmer</span></span><br><span class="line">  <span class="keyword">this</span>._rawModule = rawModule;</span><br><span class="line">  <span class="keyword">var</span> rawState = rawModule.state;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Store the origin module's state</span></span><br><span class="line">  <span class="keyword">this</span>.state = (<span class="keyword">typeof</span> rawState === <span class="string">'function'</span> ? rawState() : rawState) || &#123;&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>通过Module 的构造函数 主要有 3个 属性，this._rawModule 表示模块的配置，this._children 表示它的所有子模块，this.state 表示这个模块定义的 state。</p>
<p>在 register 函数中 实例化一个 Module 后，会判断 当前 path 的长度，如果为0，它就是一个根模块，会将 newModule 实例赋值给this.root,否则就<br>会运行如下代码建立父子关系。<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const parent = <span class="built_in">this</span>.<span class="keyword">get</span>(path.slice(<span class="number">0</span>, <span class="number">-1</span>));</span><br><span class="line">parent.addChild(path[path.length - <span class="number">1</span>], <span class="keyword">new</span><span class="type">Module</span>)</span><br></pre></td></tr></table></figure></p>
<p>这一步的代码 很清晰，先找到 父，然后通过父模块的addChild 建立父子模块。<br>再回到register 方法 它的最后一步判断如果有子模块存在 就根据 key 作为 path，递归调用register方法，这样在上一步判断 path 长度时就不会为0了。<br><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ModuleCollection.prototype.get = <span class="keyword">function</span> get <span class="built_in">(path</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span><span class="built_in"> path</span>.reduce(<span class="keyword">function</span> (<span class="keyword">module</span>,<span class="built_in"> key</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">module</span>.getChild<span class="built_in">(key</span>)</span><br><span class="line">  &#125;, this<span class="built_in">.root</span>)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>传入的 path 是它的父模块的 path，然后从根模块开始，通过 reduce 方法一层层去找到对应的模块，查找的过程中，执行的是 module.getChild(key) 方法：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Module.prototype.getChild = <span class="function"><span class="keyword">function</span> <span class="title">getChild</span> (<span class="params">key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>._children[key]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>看代码一目了然，就是返回当前模块的 _children 中对应 key 的模块，每个模块的 _children 是通过执行 parent.addChild(path[path.length - 1], newModule) 方法添加：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Module.prototype.addChild = <span class="function"><span class="keyword">function</span> <span class="title">addChild</span> (<span class="params">key, module</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>._children[key] = <span class="built_in">module</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>其实 对于 子模块而言，它们的 parent 就是上一层 module，这样它们就会通过 父模块的 addChild 方法被添加到 父模块 的 _children 中。递归执行这样的过程，实例出一颗完整的模块树。</p>
<h4 id="第二步：安装模块"><a href="#第二步：安装模块" class="headerlink" title="第二步：安装模块"></a>第二步：安装模块</h4><p>实例化完模块后, debugger回到 Store 函数中。</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var <span class="keyword">state</span> = this._modules.root.<span class="keyword">state</span>;</span><br><span class="line">installModule(this, <span class="keyword">state</span>, [], this._modules.root);</span><br></pre></td></tr></table></figure>
<p>installModule 函数如下：<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">installModule</span> (<span class="params">store, rootState, path, <span class="built_in">module</span>, hot</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> isRoot = !path.length;</span><br><span class="line">  <span class="keyword">var</span> <span class="keyword">namespace</span> = store._modules.getNamespace(path);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// register in namespace map</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">module</span>.namespaced) &#123;</span><br><span class="line">    <span class="keyword">if</span> (store._modulesNamespaceMap[<span class="keyword">namespace</span>] &amp;&amp; process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      <span class="built_in">console</span>.error((<span class="string">"[vuex] duplicate namespace "</span> + <span class="keyword">namespace</span> + <span class="string">" for the namespaced module "</span> + (path.join(<span class="string">'/'</span>))));</span><br><span class="line">    &#125;</span><br><span class="line">    store._modulesNamespaceMap[<span class="keyword">namespace</span>] = <span class="keyword">module</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // set state</span><br><span class="line">  if (!isRoot &amp;&amp; !hot) &#123;</span><br><span class="line">    <span class="keyword">var</span> parentState = getNestedState(rootState, path.slice(<span class="number">0</span>, <span class="number">-1</span>));</span><br><span class="line">    <span class="keyword">var</span> moduleName = path[path.length - <span class="number">1</span>];</span><br><span class="line">    store._withCommit(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (moduleName <span class="keyword">in</span> parentState) &#123;</span><br><span class="line">          <span class="built_in">console</span>.warn(</span><br><span class="line">            (<span class="string">"[vuex] state field \""</span> + moduleName + <span class="string">"\" was overridden by a module with the same name at \""</span> + (path.join(<span class="string">'.'</span>)) + <span class="string">"\""</span>)</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      Vue.set(parentState, moduleName, <span class="built_in">module</span>.state);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> local = <span class="built_in">module</span>.context = makeLocalContext(store, <span class="keyword">namespace</span>, path);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">module</span>.forEachMutation(<span class="function"><span class="keyword">function</span> (<span class="params">mutation, key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> namespacedType = <span class="keyword">namespace</span> + key;</span><br><span class="line">    registerMutation(store, namespacedType, mutation, local);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">module</span>.forEachAction(<span class="function"><span class="keyword">function</span> (<span class="params">action, key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="keyword">type</span> = action.root ? key : <span class="keyword">namespace</span> + key;</span><br><span class="line">    <span class="keyword">var</span> handler = action.handler || action;</span><br><span class="line">    registerAction(store, <span class="keyword">type</span>, handler, local);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">module</span>.forEachGetter(<span class="function"><span class="keyword">function</span> (<span class="params">getter, key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> namespacedType = <span class="keyword">namespace</span> + key;</span><br><span class="line">    registerGetter(store, namespacedType, getter, local);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">module</span>.forEachChild(<span class="function"><span class="keyword">function</span> (<span class="params">child, key</span>) </span>&#123;</span><br><span class="line">    installModule(store, rootState, path.concat(key), child, hot);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>installModule 函数方法有 5 个入参，store 表示 root store；state 表示 root state；path 表示模块的访问路径；module 表示当前的模块，hot 表示是否是热更新。 </p>
<p>默认情况下，模块内部的 action、mutation 和 getter 是注册在全局命名空间的——这样使得多个模块能够对同一 mutation 或 action 作出响应。</p>
<p>如果希望你的模块具有更高的封装度和复用性，你可以通过添加 namespaced: true 的方式使其成为带命名空间的模块。当模块被注册后，它的所有 getter、action 及 mutation 都会自动根据模块注册的路径调整命名。启用了命名空间的 getter 和 action 会收到局部化的 getter，dispatch 和 commit。换言之，你在使用模块内容（module assets）时不需要在同一模块内额外添加空间名前缀。更改 namespaced 属性后不需要修改模块内的代码。<br>获取命名空间的方法如下：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">namespace</span> = store._modules.getNamespace(path)</span><br></pre></td></tr></table></figure></p>
<p>方法的具体实现：<br><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ModuleCollection.prototype.getNamespace = <span class="keyword">function</span> getNamespace <span class="built_in">(path</span>) &#123;</span><br><span class="line">  var <span class="keyword">module</span> = this<span class="built_in">.root</span>;</span><br><span class="line">  <span class="keyword">return</span><span class="built_in"> path</span>.reduce(<span class="keyword">function</span> (<span class="type">namespace</span>,<span class="built_in"> key</span>) &#123;</span><br><span class="line">    <span class="keyword">module</span> = <span class="keyword">module</span>.getChild<span class="built_in">(key</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="type">namespace</span> + (<span class="keyword">module</span>.namespaced ?<span class="built_in"> key</span> + <span class="string">'/'</span> : <span class="string">''</span>)</span><br><span class="line">  &#125;, <span class="string">''</span>)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>namespaced 为 true 且 没有冲突的情况下会将 namespace 对应的模块保存下来 :<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">store._modulesNamespaceMap[namespace]</span> = module<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>接下来 会 判断 是否 是root 然后执行 以下方法 拿到 state，然后通过Vue.set 一层层 初始化 state。<br><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function getNestedState (<span class="keyword">state</span>, path) &#123;</span><br><span class="line">  return path.length</span><br><span class="line">    ? path.reduce(function (<span class="keyword">state</span>, key) &#123; return <span class="keyword">state</span>[key]; &#125;, <span class="keyword">state</span>)</span><br><span class="line">    : <span class="keyword">state</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来会执行 makeLocalContext 方法：<br> <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeLocalContext</span> (<span class="params">store, <span class="keyword">namespace</span>, path</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> noNamespace = <span class="keyword">namespace</span> === <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> local = &#123;</span><br><span class="line">    dispatch: noNamespace ? store.dispatch : <span class="function"><span class="keyword">function</span> (<span class="params">_type, _payload, _options</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> args = unifyObjectStyle(_type, _payload, _options);</span><br><span class="line">      <span class="keyword">var</span> payload = args.payload;</span><br><span class="line">      <span class="keyword">var</span> options = args.options;</span><br><span class="line">      <span class="keyword">var</span> <span class="keyword">type</span> = args.type;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!options || !options.root) &#123;</span><br><span class="line">        <span class="keyword">type</span> = <span class="keyword">namespace</span> + <span class="keyword">type</span>;</span><br><span class="line">        <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; !store._actions[<span class="keyword">type</span>]) &#123;</span><br><span class="line">          <span class="built_in">console</span>.error((<span class="string">"[vuex] unknown local action type: "</span> + (args.type) + <span class="string">", global type: "</span> + <span class="keyword">type</span>));</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> store.dispatch(<span class="keyword">type</span>, payload)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    commit: noNamespace ? store.commit : <span class="function"><span class="keyword">function</span> (<span class="params">_type, _payload, _options</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> args = unifyObjectStyle(_type, _payload, _options);</span><br><span class="line">      <span class="keyword">var</span> payload = args.payload;</span><br><span class="line">      <span class="keyword">var</span> options = args.options;</span><br><span class="line">      <span class="keyword">var</span> <span class="keyword">type</span> = args.type;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!options || !options.root) &#123;</span><br><span class="line">        <span class="keyword">type</span> = <span class="keyword">namespace</span> + <span class="keyword">type</span>;</span><br><span class="line">        <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; !store._mutations[<span class="keyword">type</span>]) &#123;</span><br><span class="line">          <span class="built_in">console</span>.error((<span class="string">"[vuex] unknown local mutation type: "</span> + (args.type) + <span class="string">", global type: "</span> + <span class="keyword">type</span>));</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      store.commit(<span class="keyword">type</span>, payload, options);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getters and state object must be gotten lazily</span></span><br><span class="line">  <span class="comment">// because they will be changed by vm update</span></span><br><span class="line">  <span class="built_in">Object</span>.defineProperties(local, &#123;</span><br><span class="line">    getters: &#123;</span><br><span class="line">      <span class="keyword">get</span>: noNamespace</span><br><span class="line">        ? <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="keyword">return</span> store.getters; &#125;</span><br><span class="line">        : <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="keyword">return</span> makeLocalGetters(store, <span class="keyword">namespace</span>); &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    state: &#123;</span><br><span class="line">      <span class="keyword">get</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="keyword">return</span> getNestedState(store.state, path); &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> local</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>makeLocalContext 有 3 个入参，store 表示 root store；namespace 表示模块的命名空间，path 表示模块的 path。该方法定义了 local 对象，对于 dispatch 和 commit 方法，如果没有 namespace，它们就直接指向了 root store 的 dispatch 和 commit 方法，否则会创建方法，把 type 自动拼接上 namespace，然后执行 store 上对应的方法。</p>
<p>debugger 回到 installModule ，这里接下来就是 分别完成  Mutation，Action，Getter 的注册。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">registerMutation</span> <span class="params">(store, type, handler, local)</span></span> &#123;</span><br><span class="line">  var entry = store._mutations[<span class="built_in">type</span>] || (store._mutations[<span class="built_in">type</span>] = []);</span><br><span class="line">  entry.push(<span class="function"><span class="keyword">function</span> <span class="title">wrappedMutationHandler</span> <span class="params">(payload)</span></span> &#123;</span><br><span class="line">    handler.call(store, <span class="keyword">local</span>.state, payload);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">registerAction</span> <span class="params">(store, type, handler, local)</span></span> &#123;</span><br><span class="line">  var entry = store._actions[<span class="built_in">type</span>] || (store._actions[<span class="built_in">type</span>] = []);</span><br><span class="line">  entry.push(<span class="function"><span class="keyword">function</span> <span class="title">wrappedActionHandler</span> <span class="params">(payload)</span></span> &#123;</span><br><span class="line">    var res = handler.call(store, &#123;</span><br><span class="line">      dispatch: <span class="keyword">local</span>.dispatch,</span><br><span class="line">      commit: <span class="keyword">local</span>.commit,</span><br><span class="line">      getters: <span class="keyword">local</span>.getters,</span><br><span class="line">      state: <span class="keyword">local</span>.state,</span><br><span class="line">      rootGetters: store.getters,</span><br><span class="line">      rootState: store.state</span><br><span class="line">    &#125;, payload);</span><br><span class="line">    <span class="keyword">if</span> (!isPromise(res)) &#123;</span><br><span class="line">      res = Promise.resolve(res);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (store._devtoolHook) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.catch(<span class="function"><span class="keyword">function</span> <span class="params">(err)</span></span> &#123;</span><br><span class="line">        store._devtoolHook.emit(<span class="string">'vuex:error'</span>, err);</span><br><span class="line">        throw err</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> res</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">registerGetter</span> <span class="params">(store, type, rawGetter, local)</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (store._wrappedGetters[<span class="built_in">type</span>]) &#123;</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      console.<span class="built_in">error</span>((<span class="string">"[vuex] duplicate getter key: "</span> + <span class="built_in">type</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  store._wrappedGetters[<span class="built_in">type</span>] = <span class="function"><span class="keyword">function</span> <span class="title">wrappedGetter</span> <span class="params">(store)</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> rawGetter(</span><br><span class="line">      <span class="keyword">local</span>.state, // <span class="keyword">local</span> state</span><br><span class="line">      <span class="keyword">local</span>.getters, // <span class="keyword">local</span> getters</span><br><span class="line">      store.state, // root state</span><br><span class="line">      store.getters // root getters</span><br><span class="line">    )</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>installModule 方法会完成模块下的 state、mutations、actions、getters、 的初始化工作，并且通过递归遍历的方式，就完成了所有子模块的安装工作。</p>
<h4 id="第三步-注册-Store-实例"><a href="#第三步-注册-Store-实例" class="headerlink" title="第三步 注册 Store 实例"></a>第三步 注册 Store 实例</h4><p>安装完模块后, debugger回到 Store 函数中。<br><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resetStoreVM(this, <span class="keyword">state</span>);</span><br></pre></td></tr></table></figure></p>
<p>下面是方法定义：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resetStoreVM</span> <span class="params">(store, state, hot)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> oldVm = store._vm;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// bind store public getters</span></span><br><span class="line">  store.getters = &#123;&#125;;</span><br><span class="line">  <span class="comment">// reset local getters cache</span></span><br><span class="line">  store._makeLocalGettersCache = Object.create(<span class="keyword">null</span>);</span><br><span class="line">  <span class="keyword">var</span> wrappedGetters = store._wrappedGetters;</span><br><span class="line">  <span class="keyword">var</span> computed = &#123;&#125;;</span><br><span class="line">  forEachValue(wrappedGetters, <span class="function"><span class="keyword">function</span> <span class="params">(fn, key)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// use computed to leverage its lazy-caching mechanism</span></span><br><span class="line">    <span class="comment">// direct inline function use will lead to closure preserving oldVm.</span></span><br><span class="line">    <span class="comment">// using partial to return function with only arguments preserved in closure environment.</span></span><br><span class="line">    computed[key] = partial(fn, store);</span><br><span class="line">    Object.defineProperty(store.getters, key, &#123;</span><br><span class="line">      get: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123; <span class="keyword">return</span> store._vm[key]; &#125;,</span><br><span class="line">      enumerable: <span class="keyword">true</span> <span class="comment">// for local getters</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// use a Vue instance to store the state tree</span></span><br><span class="line">  <span class="comment">// suppress warnings just in case the user has added</span></span><br><span class="line">  <span class="comment">// some funky global mixins</span></span><br><span class="line">  <span class="keyword">var</span> silent = Vue.config.silent;</span><br><span class="line">  Vue.config.silent = <span class="keyword">true</span>;</span><br><span class="line">  store._vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    data: &#123;</span><br><span class="line">      $$state: state</span><br><span class="line">    &#125;,</span><br><span class="line">    computed: computed</span><br><span class="line">  &#125;);</span><br><span class="line">  Vue.config.silent = silent;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// enable strict mode for new vm</span></span><br><span class="line">  <span class="keyword">if</span> (store.strict) &#123;</span><br><span class="line">    enableStrictMode(store);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (oldVm) &#123;</span><br><span class="line">    <span class="keyword">if</span> (hot) &#123;</span><br><span class="line">      <span class="comment">// dispatch changes in all subscribed watchers</span></span><br><span class="line">      <span class="comment">// to force getter re-evaluation for hot reloading.</span></span><br><span class="line">      store._withCommit(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        oldVm._data.$$state = <span class="keyword">null</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    Vue.nextTick(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123; <span class="keyword">return</span> oldVm.$destroy(); &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>resetStoreVM 首先遍历了 _wrappedGetters 获得每个 getter 的函数 fn 和 key，然后定义了 computed[key] = () =&gt; fn(store)。这里的_wrappedGetters 方法就定义在 安装模块 registerGetter 方法中。fn(store) 等于如下方法：<br><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">store._wrappedGetters[type] = function wrappedGetter (store) &#123;</span><br><span class="line">  return rawGetter(</span><br><span class="line">    local.<span class="keyword">state</span>, // local <span class="keyword">state</span></span><br><span class="line">    local.getters, // local getters</span><br><span class="line">    store.<span class="keyword">state</span>, // root <span class="keyword">state</span></span><br><span class="line">    store.getters // root getters</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>实则 我们 访问 store.getters 是访问了store 实例 上的 get方法。<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">computed[<span class="built_in">key</span>] = partial(fn, store);</span><br><span class="line"><span class="keyword">Object</span>.defineProperty(store.getters, <span class="built_in">key</span>, &#123;</span><br><span class="line">  <span class="built_in">get</span>: function () &#123; <span class="keyword">return</span> store._vm[<span class="built_in">key</span>]; &#125;,</span><br><span class="line">  enumerable: <span class="keyword">true</span> <span class="comment">// for local getters</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>根据 key 访问 store.getters 的某一个 getter 的时候，实际上就是访问了 store._vm[key]，也就是 computed[key]，在执行 computed[key] 对应的函数的时候，会执行 rawGetter 方法，那么就会访问到 store.state，进而访问到 store._vm._data.$$state，这样就建立了一个依赖关系。当 store.state 发生变化的时候，下一次再访问 store.getters 的时候会重新计算，这里的 store._vm 创建过程在代码中也清晰可见。</p>
<p>当严格模式下，store._vm 会添加一个 wathcer 来观测 this._data.$$state 的变化，也就是当 store.state 被修改的时候, store._committing 必须为 true，否则在开发阶段会报警告。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">enableStrictMode</span> <span class="params">(store)</span> </span>&#123;</span><br><span class="line">  store._vm.$watch(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123; <span class="keyword">return</span> this._data.$$state &#125;, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      assert(store._committing, <span class="string">"do not mutate vuex store state outside mutation handlers."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, &#123; deep: <span class="keyword">true</span>, sync: <span class="keyword">true</span> &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从 debugger 可以看到，在 Commit 过程中会执行 _withCommit 函数， 其实也就是 在 fn 之前 将_committing 变量 改为true。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Store.prototype._withCommit = <span class="function"><span class="keyword">function</span> <span class="title">_withCommit</span> (<span class="params">fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> committing = <span class="keyword">this</span>._committing;</span><br><span class="line">  <span class="keyword">this</span>._committing = <span class="literal">true</span>;</span><br><span class="line">  fn();</span><br><span class="line">  <span class="keyword">this</span>._committing = committing;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><iframe src="/donate/?AliPayQR=/img/alipay.jpeg&amp;WeChatQR=null&amp;GitHub=https://github.com/DavidYuanX&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><div class="tags"><a href="/tags/Vue/">Vue</a><a href="/tags/Vuex/">Vuex</a></div><div class="post-nav"><a class="pre" href="/2019/06/10/Vue-router/">Vue源码分析之 Vue-router 篇</a><a class="next" href="/2019/05/30/Vue-init/">Vue源码分析之this.message 为什么能访问到 data.message</a></div><div id="vcomment"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/@waline/client@v2/dist/waline.css"><script src="//unpkg.com/@waline/client@v2/dist/waline.js"></script><script>const waline = Waline.init({
  el: '#vcomment',
  path: decodeURI(location.pathname) || '/',
  lang: 'zh-cn',
  serverURL: 'https://vercel-xi-gilt.vercel.app',
  pageSize:'10'
});</script></div></div></div><aside class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input class="popup-trigger" placeholder="Search" readonly="readonly"></div></div><div class="toc-article" id="toc"><div class="toc-title">Categories<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Vuex-是什么？"><span class="toc-number">1.</span> <span class="toc-text">Vuex 是什么？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vuex-初始化"><span class="toc-number">2.</span> <span class="toc-text">Vuex 初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装"><span class="toc-number">2.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Store-实例化"><span class="toc-number">2.2.</span> <span class="toc-text">Store 实例化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#第一步：实例化模块，创建模块树"><span class="toc-number">2.2.1.</span> <span class="toc-text">第一步：实例化模块，创建模块树</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第二步：安装模块"><span class="toc-number">2.2.2.</span> <span class="toc-text">第二步：安装模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第三步-注册-Store-实例"><span class="toc-number">2.2.3.</span> <span class="toc-text">第三步 注册 Store 实例</span></a></li></ol></li></ol></li></ol></div></div></div></aside><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2022 <a href="/." rel="nofollow">David's blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv"><i class="fa fa-eye" aria-hidden="true"></i> <span id="busuanzi_value_site_pv"></span> times</span></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/underscore-min.js"></script><script type="text/javascript" src="/js/inView.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>